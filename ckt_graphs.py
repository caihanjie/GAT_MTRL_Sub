import torch
import numpy as np
import os


class GraphAMPNMCF:
    """                                                                                                                           

    node 0 : M0 , node 1 : M1 , node 2 : M2 , node 3 : M3 , node 4 : M4 , node 5 : M5
    node 6 : M6 , node 7 : M7 , node 8 : M8 , node 9 : M9 , node 10 : M10 , node 11 : M11
    node 12 : M12 , node 13 : M13 , node 14 : M14 , node 15 : M15 , node 16 : M16 , node17 : M17 ,
    node 18 : M18 , node 19 : M19 , node 20 : M20 , node 21 : M21 , node 22 : M22 ,   
    node23 : M23 , node24 : Ib , node25 : VDD , node26 : GND , node27 : C0 , node28 : C1

    """
    def __init__(self):        
        
        self.device = torch.device(
           "cpu"
        )
        self.ckt_hierarchy = (
                      ('M0','x1.XM0','pfet_01v8','m'),
                      ('M1','x1.XM1','pfet_01v8','m'),
                      ('M2','x1.XM2','pfet_01v8','m'),
                      ('M3','x1.XM3','pfet_01v8','m'),
                      ('M4','x1.XM4','pfet_01v8','m'),
                      ('M5','x1.XM5','pfet_01v8','m'),
                      ('M6','x1.XM6','pfet_01v8','m'),
                      ('M7','x1.XM7','pfet_01v8','m'),
                      ('M8','x1.XM8','pfet_01v8','m'),
                      ('M9','x1.XM9','pfet_01v8','m'),
                      ('M10','x1.XM10','pfet_01v8','m'),
                      ('M11','x1.XM11','pfet_01v8','m'),
                      ('M12','x1.XM12','nfet_01v8','m'),
                      ('M13','x1.XM13','nfet_01v8','m'),
                      ('M14','x1.XM14','nfet_01v8','m'),
                      ('M15','x1.XM15','nfet_01v8','m'),
                      ('M16','x1.XM16','nfet_01v8','m'),
                      ('M17','x1.XM17','nfet_01v8','m'),
                      ('M18','x1.XM18','nfet_01v8','m'),
                      ('M19','x1.XM19','nfet_01v8','m'),
                      ('M20','x1.XM20','nfet_01v8','m'),
                      ('M21','x1.XM21','nfet_01v8','m'),
                      ('M22','x1.XM22','nfet_01v8','m'),
                      ('M23','x1.XM23','nfet_01v8','m'),

                      ('Ib','','Ib','i'),
                      ('C0','x1.XC0','cap_mim_m3_1','c'),
                      ('C1','x1.XC1','cap_mim_m3_1','c')
                     )    

        self.op = {'M0':{},'M1':{},'M2':{},'M3':{},'M4':{},'M5':{},'M6':{},'M7':{},'M8':{}, 'M9':{},'M10':{},'M10':{},'M11':{},
                'M12':{},'M13':{},'M14':{},'M15':{},'M16':{},'M17':{},'M18':{},'M19':{},'M20':{},'M21':{},'M22':{},'M23':{},
                'Ib':{},'C0':{},'C1':{}
                 }

        self.edge_index = torch.tensor([
          [0,1], [1,0], [0,2], [2,0], [0,3], [3,0], [0,4], [4,0], [0,7], [7,0], [0,24], [24,0], [0,25], [25,0], 
          [1,2], [2,1], [1,3], [3,1], [1,4], [4,1], [1,7], [7,1], [1,25], [25,1], [1,12], [12,1], [1,24], [24,1], [1,17], [17,1], [1,18], [18,1], [1,19], [19,1], [1,20], [20,1], 
          [2,3], [3,2], [2,4], [4,2], [2,7], [7,2], [2,24], [24,2], [2,13], [13,2], [2,25], [25,2],  
          [3,4], [4,3], [3,7], [7,3], [3,24], [24,3], [3,25], [25,3], [3,12], [12,3], [3,13], [13,3], [3,14], [14,3], [3,15], [15,3], [3,16], [16,3], 
          [4,7], [7,4], [4,24], [24,4], [4,8], [8,4], [4,9], [9,4], [4,25], [25,4],
          [5,6], [6,5], [5,15], [15,5], [5,25], [25,5], 
          [6,15], [15,6], [6,16], [16,6], [6,10], [10,6], [6,11], [11,6], [6,25], [25,6], [6,27], [27,6], 
          [7,24], [24,7], [7,25], [25,7], [7,22], [22,7], [7,23], [23,7], [7,28], [28,7],
          [8,9], [9,8], [8,15], [15,8], [8,19], [19,8], 
          [9,16], [16,9], [9,20], [20,9], 
          [10,11], [11,10], [10,16], [16,10], [10,21], [21,10], [10,22], [22,10], [10,25], [25,10], [10,27], [27,10],
          [11,25], [25,11], [11,16], [16,11], [11,23], [23,11], [11,27], [27,11], [11,28], [28,11], 
          [12,13], [13,12], [12,14], [14,12], [12,15], [15,12], [12,16], [16,12], [12,17], [17,12], [12,18], [18,12], [12,19], [19,12], [12,20], [20,12], 
          [13,14], [14,13], [13,15], [15,13], [13,16], [16,13], [13,18], [18,13],
          [14,15], [15,14], [14,16], [16,14], [14,26], [26,14],  
          [15,16], [16,15], [15,19], [19,15], 
          [16,20], [20,16], [16,27], [27,16], 
          [17,18], [18,17], [17,19], [19,17], [17,20], [20,17], [17,26], [26,17], 
          [18,19], [19,18], [18,20], [20,18], [18,26], [26,18],
          [19,20], [20,19], [19,26], [26,19], 
          [20,26], [26,20], 
          [21,22], [22,21], [21,26], [26,21], 
          [22,23], [23,22], [22,26], [26,22], [22,28], [28,22],
          [23,26], [26,23], [23,27], [27,23], [23,28], [28,23], 
          [24,26], [26,24]
            ], dtype=torch.long).t().to(self.device)
        
        self.edge_type = torch.tensor([
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1,             
            0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,   
            0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1,                   
            0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 1, 1, 0, 0, 0, 0, 1, 1,                         
            0, 0, 0, 0, 1, 1,                                     
            0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0,                   
            1, 1, 1, 1, 0, 0, 0, 0, 0, 0,                         
            0, 0, 0, 0, 0, 0,                                     
            0, 0, 0, 0,                                           
            0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0,                   
            1, 1, 0, 0, 0, 0, 0, 0, 0, 0,                         
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,       
            0, 0, 0, 0, 0, 0, 0, 0,                               
            0, 0, 0, 0, 1, 1,                                     
            0, 0, 0, 0,                                           
            0, 0, 0, 0,                                           
            0, 0, 0, 0, 0, 0, 1, 1,                               
            0, 0, 0, 0, 1, 1,                                     
            0, 0, 1, 1,                                           
            1, 1,                                                 
            0, 0, 1, 1,                                           
            0, 0, 1, 1, 0, 0,                                     
            1, 1, 0, 0, 0, 0,                                     
            1, 1,                                                 
            ]).to(self.device)
        
        self.num_relations = 2
        self.num_nodes = 29
        self.num_node_features = 12
        self.obs_shape = (self.num_nodes, self.num_node_features)

        

        self.L_C1 = 30 
        self.W_C1 = 30
        M_C1_low = 1
        M_C1_high = 40 
        self.C1_low = M_C1_low * (self.L_C1 * self.W_C1 * 2e-15 + (self.L_C1 + self.W_C1)*0.38e-15)
        self.C1_high = M_C1_high * (self.L_C1 * self.W_C1 * 2e-15 + (self.L_C1 + self.W_C1)*0.38e-15)
        
        self.W_C0 = 30
        self.L_C0 = 30
        M_C0_low = 1
        M_C0_high = 40
        self.C0_low = M_C0_low * (self.L_C0 * self.W_C0 * 2e-15 + (self.L_C0 + self.W_C0) *0.38e-15)
        self.C0_high = M_C0_high * (self.L_C0 * self.W_C0 * 2e-15 + (self.L_C0 + self.W_C0)*0.38e-15)
        
        self.action_space_low = np.array([ 0.5, 0.5, 1, 
                                        0.5, 0.5, 1,    
                                        0.5, 0.5, 1,    
                                        0.5, 0.5, 1,   
                                        0.5, 0.5, 1,    
                                        0.5, 0.5, 1,    
                                        0.5, 0.5, 1,    
                                        1e-6,           
                                        M_C0_low,       
                                        M_C1_low])      
        
        self.action_space_high = np.array([10, 5, 50,  
                                        10, 5, 50,     
                                        10, 5, 50,     
                                        10, 5, 500,    
                                        10, 5, 50,     
                                        10, 5, 50,    
                                        10, 5, 50,    
                                        50e-6,        
                                        M_C0_high,    
                                        M_C1_high])   
        
        self.action_dim = len(self.action_space_low)
        self.action_shape = (self.action_dim,)    
        
        
        self.phase_margin_target = 60 
        self.CL = 100  
        self.dcgain_target = 130
        self.PSRP_target = -80
        self.PSRN_target = -80 
        self.cmrrdc_target = -80
        self.vos_target = 0.06e-3   
        self.TC_target = 10e-6
        self.settlingTime_target = 1e-6
        self.FOML_target = 160
        self.FOMS_target = 300
        self.Active_Area_target = 150
        self.Power_target = 0.3
        self.GBW_target = 1.2e6
        self.sr_target = 0.6        

        
        self.PSRR_base = -60
        self.cmrrdc_base = -60
        self.dcgain_base = 90
        self.FOMS_base = 200
        self.FOML_base = 60
        self.settlingTime_base = 5e-6
        self.Active_Area_base = 200
        self.TC_base = 50e-6
        self.vos_base = 0.1e-3
        self.Power_base = 0.5
        self.sr_base = 0.3
        self.GBW_base = 1e6

        self.GND = 0
        self.Vdd = 1.8       
        